# Makefile Enhanced v3.0 - LibVisualMem Validation System
# ======================================================
# 
# Compilation du syst√®me de validation am√©lior√© bas√© sur l'analyse
# des m√©triques compar√©es avec les donn√©es r√©elles 2025
# 
# Am√©liorations incluses :
# - Transparence technique compl√®te
# - Tests multi-threading avanc√©s
# - Stress tests 24h
# - Comparaisons DDR4/DDR5/SSD/NVMe r√©elles
# - Environnements headless (framebuffer virtuel)
# - Justification des d√©bits √©lev√©s (GPU RAM, compression)

CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -O2 -g -D_GNU_SOURCE
LDFLAGS = -lpthread -lX11 -lGL -lGLU -lm -lrt

# Directories
SRC_DIR = .
OBJ_DIR = obj_enhanced_v3
BIN_DIR = bin_enhanced_v3

# Source files
SOURCES = validation_benchmark_v3_enhanced.c libvisualmem_v2.c
OBJECTS = $(SOURCES:%.c=$(OBJ_DIR)/%.o)

# Target executable
TARGET = $(BIN_DIR)/validation_enhanced_v3

# Default target
all: directories $(TARGET)

# Create necessary directories
directories:
	@mkdir -p $(OBJ_DIR)
	@mkdir -p $(BIN_DIR)
	@mkdir -p logs_enhanced_v3
	@mkdir -p reports_enhanced_v3

# Compile object files
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c
	@echo "üî® Compiling $<..."
	@$(CC) $(CFLAGS) -c $< -o $@

# Link executable
$(TARGET): $(OBJECTS)
	@echo "üîó Linking $@..."
	@$(CC) $(OBJECTS) -o $@ $(LDFLAGS)
	@echo "‚úÖ Enhanced validation system built successfully"

# Clean build artifacts
clean:
	@echo "üßπ Cleaning build artifacts..."
	@rm -rf $(OBJ_DIR) $(BIN_DIR)
	@echo "‚úÖ Clean completed"

# Install dependencies (Ubuntu/Debian)
install-deps:
	@echo "üì¶ Installing dependencies..."
	@sudo apt-get update
	@sudo apt-get install -y \
		build-essential \
		libx11-dev \
		libgl1-mesa-dev \
		libglu1-mesa-dev \
		libxrandr-dev \
		libxinerama-dev \
		libxcursor-dev \
		libxi-dev \
		xvfb \
		mesa-utils
	@echo "‚úÖ Dependencies installed"

# Run validation tests
test: $(TARGET)
	@echo "üß™ Running enhanced validation tests..."
	@$(TARGET)

# Run with specific configuration
test-headless: $(TARGET)
	@echo "üñ•Ô∏è  Running headless validation tests..."
	@DISPLAY=:99 Xvfb :99 -screen 0 800x600x24 &
	@sleep 2
	@$(TARGET)
	@pkill Xvfb

# Run stress test (long duration)
test-stress: $(TARGET)
	@echo "‚è∞ Running stress test (24h simulation)..."
	@$(TARGET)

# Generate documentation
docs:
	@echo "üìö Generating enhanced documentation..."
	@echo "# LibVisualMem v3.0 Enhanced Validation System" > README_ENHANCED.md
	@echo "" >> README_ENHANCED.md
	@echo "## üöÄ Features" >> README_ENHANCED.md
	@echo "" >> README_ENHANCED.md
	@echo "- **Real Metrics Validation**: DDR4/DDR5/SSD/NVMe comparisons" >> README_ENHANCED.md
	@echo "- **Multi-threading Tests**: 8-thread concurrent operations" >> README_ENHANCED.md
	@echo "- **Compression Analysis**: Pattern-based compression testing" >> README_ENHANCED.md
	@echo "- **GPU Memory Usage**: Direct video memory analysis" >> README_ENHANCED.md
	@echo "- **Headless Environment**: Xvfb framebuffer testing" >> README_ENHANCED.md
	@echo "- **Stress Testing**: 24-hour simulation" >> README_ENHANCED.md
	@echo "- **Technical Transparency**: Detailed performance justification" >> README_ENHANCED.md
	@echo "" >> README_ENHANCED.md
	@echo "## üìä Real Metrics 2025" >> README_ENHANCED.md
	@echo "" >> README_ENHANCED.md
	@echo "| Technology | Latency | Bandwidth | Source |" >> README_ENHANCED.md
	@echo "|------------|---------|-----------|--------|" >> README_ENHANCED.md
	@echo "| DDR4 | 50-80 ns | 25.6 GB/s | AnandTech |" >> README_ENHANCED.md
	@echo "| DDR5 | 40-60 ns | 51.2 GB/s | TechPowerUp |" >> README_ENHANCED.md
	@echo "| NVMe | 10-50 Œºs | 7 GB/s | Tom's Hardware |" >> README_ENHANCED.md
	@echo "| GPU GDDR6X | 100-200 ns | 700 GB/s | GPU Reviews |" >> README_ENHANCED.md
	@echo "" >> README_ENHANCED.md
	@echo "## üîß Build Instructions" >> README_ENHANCED.md
	@echo "" >> README_ENHANCED.md
	@echo '```bash' >> README_ENHANCED.md
	@echo 'make install-deps  # Install dependencies' >> README_ENHANCED.md
	@echo 'make               # Build validation system' >> README_ENHANCED.md
	@echo 'make test          # Run validation tests' >> README_ENHANCED.md
	@echo 'make test-headless # Run headless tests' >> README_ENHANCED.md
	@echo 'make test-stress   # Run stress tests' >> README_ENHANCED.md
	@echo '```' >> README_ENHANCED.md
	@echo "‚úÖ Documentation generated: README_ENHANCED.md"

# Performance analysis
analyze: $(TARGET)
	@echo "üìä Running performance analysis..."
	@$(TARGET) > performance_analysis.log 2>&1
	@echo "üìà Performance analysis completed: performance_analysis.log"

# Create validation script
create-script:
	@echo "üìù Creating validation automation script..."
	@echo '#!/bin/bash' > validation_enhanced_v3.sh
	@echo '' >> validation_enhanced_v3.sh
	@echo '# LibVisualMem v3.0 Enhanced Validation Script' >> validation_enhanced_v3.sh
	@echo '# ============================================' >> validation_enhanced_v3.sh
	@echo '' >> validation_enhanced_v3.sh
	@echo 'set -e' >> validation_enhanced_v3.sh
	@echo '' >> validation_enhanced_v3.sh
	@echo 'echo "üöÄ Starting enhanced validation process..."' >> validation_enhanced_v3.sh
	@echo '' >> validation_enhanced_v3.sh
	@echo '# Build system' >> validation_enhanced_v3.sh
	@echo 'make clean' >> validation_enhanced_v3.sh
	@echo 'make' >> validation_enhanced_v3.sh
	@echo '' >> validation_enhanced_v3.sh
	@echo '# Run tests' >> validation_enhanced_v3.sh
	@echo 'echo "üß™ Running enhanced validation tests..."' >> validation_enhanced_v3.sh
	@echo './bin_enhanced_v3/validation_enhanced_v3' >> validation_enhanced_v3.sh
	@echo '' >> validation_enhanced_v3.sh
	@echo '# Generate report' >> validation_enhanced_v3.sh
	@echo 'echo "üìÑ Generating validation report..."' >> validation_enhanced_v3.sh
	@echo 'make docs' >> validation_enhanced_v3.sh
	@echo '' >> validation_enhanced_v3.sh
	@echo 'echo "‚úÖ Enhanced validation completed successfully"' >> validation_enhanced_v3.sh
	@chmod +x validation_enhanced_v3.sh
	@echo "‚úÖ Validation script created: validation_enhanced_v3.sh"

# Help target
help:
	@echo "LibVisualMem v3.0 Enhanced Validation System"
	@echo "============================================"
	@echo ""
	@echo "Available targets:"
	@echo "  all              - Build the enhanced validation system"
	@echo "  clean            - Clean build artifacts"
	@echo "  install-deps     - Install system dependencies"
	@echo "  test             - Run validation tests"
	@echo "  test-headless    - Run headless validation tests"
	@echo "  test-stress      - Run stress tests (24h simulation)"
	@echo "  docs             - Generate documentation"
	@echo "  analyze          - Run performance analysis"
	@echo "  create-script    - Create validation automation script"
	@echo "  help             - Show this help message"
	@echo ""
	@echo "Real Metrics 2025 Validation:"
	@echo "  - DDR4: 50-80 ns, 25.6 GB/s"
	@echo "  - DDR5: 40-60 ns, 51.2 GB/s"
	@echo "  - NVMe: 10-50 Œºs, 7 GB/s"
	@echo "  - GPU GDDR6X: 100-200 ns, 700 GB/s"

# Phony targets
.PHONY: all clean install-deps test test-headless test-stress docs analyze create-script help directories